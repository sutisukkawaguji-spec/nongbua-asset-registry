<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏û‡∏±‡∏™‡∏î‡∏∏ | ‡∏ò‡∏ô‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Sarabun', 'sans-serif'] },
          colors: {
            royal: { DEFAULT: '#1e40af', light: '#3b82f6', dark: '#1e3a8a' },
            gold: { DEFAULT: '#f59e0b', light: '#fbbf24', dark: '#d97706' }
          }
        }
      }
    }
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden">

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx_ZarsmZi6RVUNNgMOGo7OF62nczOZaKkI5vWBqwrgePQnii27iUCboP-vKayrZ7vN/exec"; 
  </script>

  <div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center"
    style="background-image: url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=2070&q=80');">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>

    <div class="relative w-full max-w-md p-8 glass rounded-2xl shadow-2xl mx-4 border-t-4 border-gold">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-royal text-white mb-4 shadow-lg ring-4 ring-white/50">
          <span class="text-2xl">üèõÔ∏è</span>
        </div>
        <h1 class="text-xl font-bold text-slate-900">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π</h1>
        <p class="text-slate-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏û‡∏±‡∏™‡∏î‡∏∏</p>
      </div>

      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <input type="email" id="email" required
            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-royal focus:border-royal outline-none bg-white/90"
            placeholder="user@treasury.go.th">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" id="password" required
            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-royal focus:border-royal outline-none bg-white/90"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div class="flex items-center justify-between pt-2">
          <button type="button" id="btnOpenRegister" class="text-sm text-royal hover:underline font-medium">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <button type="submit" id="btnLogin"
          class="w-full py-3 bg-royal hover:bg-royal-dark text-white font-semibold rounded-lg shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
          <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          <div id="loginSpinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
        </button>
        <p id="loginMsg" class="text-center text-red-600 text-sm font-medium min-h-[20px] mt-2"></p>
      </form>
      
      <div class="mt-6 text-center text-xs text-slate-500">
        ¬© 2025 ‡∏Å‡∏£‡∏°‡∏ò‡∏ô‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå - ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê
      </div>
    </div>
  </div>

  <div id="registerOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4 animate-fade-in-up">
      <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <form id="regForm" class="space-y-4">
        <div>
            <label class="text-sm font-medium text-slate-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="reg_email" type="email" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-royal focus:border-royal outline-none">
        </div>
        <div>
            <label class="text-sm font-medium text-slate-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input id="reg_password" type="password" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-royal focus:border-royal outline-none">
        </div>
        <div>
            <label class="text-sm font-medium text-slate-700">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
            <input id="reg_agency" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-royal focus:border-royal outline-none">
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏õ‡∏•‡∏á (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ)</label>
          <input id="reg_ap" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-‡∏ô‡∏†-1, 1-‡∏ô‡∏†-2" class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-royal focus:border-royal outline-none">
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="btnRegSubmit" class="flex-1 bg-royal text-white py-2 rounded-lg hover:bg-royal-dark transition font-medium">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
          <button type="button" id="btnRegCancel" class="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg hover:bg-slate-200 transition font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
        <p id="regMsg" class="text-center text-sm min-h-[20px] text-blue-600"></p>
      </form>
    </div>
  </div>

  <div id="app" class="hidden flex flex-col h-screen">

    <header class="bg-white border-b border-slate-200 shadow-sm z-30 h-16 flex items-center justify-between px-4 lg:px-6 relative">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-royal flex items-center justify-center text-white shadow-sm">
          <span class="text-lg">üáπüá≠</span>
        </div>
        <div>
          <h1 class="font-bold text-lg text-slate-800 leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏û‡∏±‡∏™‡∏î‡∏∏</h1>
          <p class="text-xs text-royal hidden sm:block">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π</p>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <div class="text-right hidden md:block">
          <div id="userEmail" class="text-sm font-medium text-slate-800"></div>
          <div id="userRole" class="text-xs text-slate-500 uppercase tracking-wider"></div>
        </div>
        <button id="btnLogout" class="p-2 text-slate-400 hover:text-red-500 transition rounded-full hover:bg-red-50" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
          </svg>
        </button>
      </div>
    </header>

    <div class="md:hidden flex border-b border-slate-200 bg-white">
      <button id="tabMap" class="flex-1 py-3 text-sm font-medium text-royal border-b-2 border-royal transition">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
      <button id="tabList" class="flex-1 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <div class="flex-1 flex overflow-hidden relative">

      <div id="mapPanel" class="w-full md:w-[60%] h-full relative z-10 transition-all duration-300">
        <div id="map" class="w-full h-full bg-slate-100 z-0"></div>
        <div class="absolute top-4 right-4 z-[400]">
          <button id="btnLocate" class="bg-white p-2 rounded shadow text-slate-600 hover:bg-slate-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        </div>
      </div>

      <div id="listPanel" class="w-full md:w-[40%] h-full bg-white border-l border-slate-200 overflow-y-auto absolute md:relative top-0 left-0 md:left-auto z-20 hidden md:block">
        <div class="p-6 space-y-6">

          <div class="space-y-3">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
              <span class="text-royal">üîç</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏õ‡∏•‡∏á
            </h2>
            <div class="relative">
              <input type="text" id="agencySearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå..."
                class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-royal/50 focus:border-royal outline-none transition text-sm">
              <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</label>
              <select id="parcelSelect" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-royal/50 outline-none">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              </select>
            </div>
          </div>

          <hr class="border-slate-100">

          <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-blue-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
              <h3 class="font-bold text-royal text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <tbody id="tblParcels" class="divide-y divide-slate-100">
                  <tr><td class="px-4 py-4 text-center text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏õ‡∏•‡∏á</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-yellow-50 px-4 py-3 border-b border-yellow-100">
              <h3 class="font-bold text-yellow-800 text-sm">‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                  <tr>
                    <th class="px-4 py-2 font-medium">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                    <th class="px-4 py-2 font-medium">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                  </tr>
                </thead>
                <tbody id="tblBuildings" class="divide-y divide-slate-100">
                  <tr><td colspan="2" class="px-4 py-4 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // --- STATE ---
    const state = {
      user: null,
      parcels: [],
      selectedParcelNo: null
    };

    // --- DOM ELEMENTS ---
    const el = {
      loginOverlay: document.getElementById('loginOverlay'),
      app: document.getElementById('app'),
      loginForm: document.getElementById('loginForm'),
      btnLogin: document.getElementById('btnLogin'),
      loginMsg: document.getElementById('loginMsg'),
      loginSpinner: document.getElementById('loginSpinner'),
      userEmail: document.getElementById('userEmail'),
      userRole: document.getElementById('userRole'),
      parcelSelect: document.getElementById('parcelSelect'),
      agencySearch: document.getElementById('agencySearch'),
      tblParcels: document.getElementById('tblParcels'),
      tblBuildings: document.getElementById('tblBuildings'),
      // Tabs
      tabMap: document.getElementById('tabMap'),
      tabList: document.getElementById('tabList'),
      mapPanel: document.getElementById('mapPanel'),
      listPanel: document.getElementById('listPanel'),
      // Register
      registerOverlay: document.getElementById('registerOverlay'),
      btnOpenRegister: document.getElementById('btnOpenRegister'),
      btnRegSubmit: document.getElementById('btnRegSubmit'),
      btnRegCancel: document.getElementById('btnRegCancel'),
      regMsg: document.getElementById('regMsg')
    };

    // --- API HELPER ---
    async function apiCall(action, payload = {}) {
      if (API_URL.includes("XXXX")) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç API_URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        throw new Error("API_URL not configured");
      }

      // ‡πÉ‡∏ä‡πâ POST ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å request ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö payload ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
      const options = {
        method: 'POST',
        // GAS Web App ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS Preflight ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏≤‡∏á browser
        // ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Header Access-Control-Allow-Origin: * ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Server
        body: JSON.stringify({ action, ...payload })
      };

      try {
        const res = await fetch(API_URL, options);
        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        const data = await res.json();
        return data;
      } catch (err) {
        console.error("API Error:", err);
        throw err;
      }
    }

    // --- MAP SETUP ---
    let map, parcelsLayer, buildingsLayer;

    function initMap() {
      if (map) return;
      // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π (City Hall area approximation)
      map = L.map('map').setView([17.221, 102.434], 13); 

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      // Layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Parcel (‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÅ‡∏î‡∏á)
      parcelsLayer = L.geoJSON(null, {
        style: { color: '#ef4444', weight: 2, fillOpacity: 0.1 }
      }).addTo(map);

      // Layer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Buildings (‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
      buildingsLayer = L.geoJSON(null, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 6, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.8 }),
        style: { color: '#3b82f6', weight: 2 }
      }).addTo(map);

      // ‡∏õ‡∏∏‡πà‡∏° Locate me
      document.getElementById('btnLocate').addEventListener('click', () => {
        map.locate({ setView: true, maxZoom: 16 });
      });
      map.on('locationfound', e => {
        L.circleMarker(e.latlng).addTo(map).bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì").openPopup();
      });
    }

    // --- LOGIC ---

    // 1. LOGIN
    el.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      el.btnLogin.disabled = true;
      el.loginSpinner.classList.remove('hidden');
      el.loginMsg.textContent = "";

      try {
        const res = await apiCall('login', { email, password });
        if (res.allowed) {
          state.user = { email };
          await loadInitialData(email);
        } else {
          el.loginMsg.textContent = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
          el.btnLogin.disabled = false;
          el.loginSpinner.classList.add('hidden');
        }
      } catch (err) {
        el.loginMsg.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL)";
        el.btnLogin.disabled = false;
        el.loginSpinner.classList.add('hidden');
      }
    });

    // 2. LOAD DATA
    async function loadInitialData(email) {
      try {
        const res = await apiCall('getInitialData', { email });
        if (!res.ok) throw new Error(res.message);

        state.user = res.me;
        state.parcels = res.parcels || [];

        // UI Update
        el.userEmail.textContent = state.user.email;
        el.userRole.textContent = state.user.role;
        populateParcelSelect(state.parcels);

        // Switch Screen
        el.loginOverlay.classList.add('hidden');
        el.app.classList.remove('hidden');

        // Init Map
        setTimeout(() => {
          initMap();
          map.invalidateSize();
          renderParcelsOnMap(state.parcels);
        }, 300);

      } catch (err) {
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
        el.btnLogin.disabled = false;
        el.loginSpinner.classList.add('hidden');
      }
    }

    // 3. DROPDOWN & SEARCH
    function populateParcelSelect(parcels) {
      el.parcelSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
      const unique = [...new Set(parcels.map(p => p.parcel_no))].sort();
      unique.forEach(no => {
        const opt = document.createElement('option');
        opt.value = no;
        opt.textContent = `${no} (${parcels.find(p=>p.parcel_no===no)?.tambon_amphoe || '-'})`;
        el.parcelSelect.appendChild(opt);
      });
    }

    el.agencySearch.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = state.parcels.filter(p =>
        (p.parcel_no && p.parcel_no.toLowerCase().includes(term)) ||
        (p.agency_use_detail && p.agency_use_detail.toLowerCase().includes(term))
      );
      populateParcelSelect(filtered);
    });

    // 4. PARCEL SELECTION
    el.parcelSelect.addEventListener('change', async (e) => {
      const pNo = e.target.value;
      if (!pNo) return;
      state.selectedParcelNo = pNo;

      // Filter Data
      const selectedParcels = state.parcels.filter(p => p.parcel_no === pNo);
      
      // Update UI
      renderParcelTable(selectedParcels);
      renderParcelsOnMap(selectedParcels, true); // Zoom to

      // Fetch Buildings
      el.tblBuildings.innerHTML = '<tr><td colspan="2" class="px-4 py-4 text-center text-slate-400"><div class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></td></tr>';
      try {
        const buildRes = await apiCall('listBuildings', { key: pNo, email: state.user.email });
        renderBuildingsTable(buildRes);
      } catch (err) {
        console.error(err);
      }
    });

    function renderParcelTable(rows) {
      el.tblParcels.innerHTML = '';
      rows.forEach(r => {
        el.tblParcels.innerHTML += `
          <tr>
            <td class="px-4 py-3">
              <div class="font-bold text-slate-700">${r.parcel_no}</div>
              <div class="text-xs text-slate-500 mt-1">‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á: ${r.tambon_amphoe}</div>
              <div class="text-xs text-royal mt-1 bg-blue-50 p-2 rounded">${r.agency_use_detail || '-'}</div>
              <div class="text-xs text-slate-500 mt-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà: ${r.area_rnw}</div>
            </td>
          </tr>
        `;
      });
    }

    function renderBuildingsTable(rows) {
      el.tblBuildings.innerHTML = '';
      if (!rows || rows.length === 0) {
        el.tblBuildings.innerHTML = '<tr><td colspan="2" class="px-4 py-4 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</td></tr>';
        return;
      }
      rows.forEach(r => {
        const reg = r.building_reg_no || r['‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏•‡∏≥‡∏î‡∏±‡∏ö'] || '-';
        el.tblBuildings.innerHTML += `
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 font-medium text-slate-700 align-top">${reg}</td>
            <td class="px-4 py-3 text-slate-600 text-sm">${r.utilization_detail || r.use_detail || '-'}</td>
          </tr>
        `;
      });
    }

    // 5. MAP RENDERING
    function renderParcelsOnMap(rows, zoom = false) {
      parcelsLayer.clearLayers();
      const group = L.featureGroup();
      let hasGeom = false;

      rows.forEach(r => {
        if (r.geom_geojson) {
          try {
            const geo = JSON.parse(r.geom_geojson);
            const l = L.geoJSON(geo, { style: { color: '#ef4444', weight: 3, fillOpacity: 0.2 } });
            l.bindPopup(`<b>‡πÅ‡∏õ‡∏•‡∏á: ${r.parcel_no}</b><br>${r.agency_use_detail}`);
            parcelsLayer.addLayer(l);
            group.addLayer(l);
            hasGeom = true;
          } catch (e) { }
        }
      });

      if (zoom && hasGeom) {
        map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 18 });
      }
    }

    // 6. TABS (Mobile)
    el.tabMap.addEventListener('click', () => {
      el.tabMap.classList.add('text-royal', 'border-royal');
      el.tabMap.classList.remove('text-slate-500');
      el.tabList.classList.remove('text-royal', 'border-royal');
      el.tabList.classList.add('text-slate-500');
      el.mapPanel.classList.remove('hidden');
      el.listPanel.classList.add('hidden');
      setTimeout(() => map.invalidateSize(), 100);
    });

    el.tabList.addEventListener('click', () => {
      el.tabList.classList.add('text-royal', 'border-royal');
      el.tabList.classList.remove('text-slate-500');
      el.tabMap.classList.remove('text-royal', 'border-royal');
      el.tabMap.classList.add('text-slate-500');
      el.listPanel.classList.remove('hidden');
      el.mapPanel.classList.add('hidden');
    });

    // 7. REGISTER & LOGOUT
    document.getElementById('btnLogout').addEventListener('click', () => location.reload());
    
    el.btnOpenRegister.addEventListener('click', () => el.registerOverlay.classList.remove('hidden'));
    el.btnRegCancel.addEventListener('click', () => {
        el.registerOverlay.classList.add('hidden');
        el.regMsg.textContent = "";
    });

    el.btnRegSubmit.addEventListener('click', async () => {
      const email = document.getElementById('reg_email').value;
      const password = document.getElementById('reg_password').value;
      const agency = document.getElementById('reg_agency').value;
      const ap = document.getElementById('reg_ap').value;

      el.regMsg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      
      try {
        const res = await apiCall('register', { email, password, agency, allowed_parcels: ap });
        if (res.ok) {
          alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
          el.registerOverlay.classList.add('hidden');
        } else {
          el.regMsg.textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message;
        }
      } catch (e) {
        el.regMsg.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e.message;
      }
    });

  </script>
</body>
</html>
